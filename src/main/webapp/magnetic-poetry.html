<lift:surround with="default" at="content">
<head>
    <title>Magnetic Poetry</title>
    <style>
    /*<![CDATA[*/    
    #shape-container
    {
        position: relative;
        width: 500px;
        height: 500px;
        border: 1px solid black;
    }
    
    #shape-container div
    {
        position: absolute;
        background: white;
        cursor: move;
        border-bottom: 2px solid black;
        border-right: 2px solid black;
        border-top: 1px solid #AAA;
        border-left: 1px solid #AAA;
        padding: 0px 5px;
    }
    /*]]>*/
    </style>
    <script type="text/javascript" src="/classpath/json.js" id="json"/>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.1/jquery-ui.min.js"/>
</head>
<div id="shape-container">
</div>
<lift:comet type="MagneticPoetryDisplay"/>
<script type="text/javascript">
//<![CDATA[
    var sendUpdate = (function() {
        var curTime = (new Date()).getTime();
        var lastSent = curTime;
        var lastMove = curTime;
        var message = { };
                
        return function sendUpdate(name, x, y, forced) {
            curTime = (new Date()).getTime();
            
            if(!forced && curTime - lastMove < 50) { return; }
            
            lastMove = curTime
            if(!message[name]) { message[name] = []; }
            message[name].push([ x, y, curTime ]);
            
            if(!forced && curTime - lastMove < 150 && curTime - lastSent < 1000) { return; }
            
            if(!forced && curTime - lastSent < 300) { return; }
            
            lastSent = curTime;
            moveShape(message);
            message = { };
        };
    })();
    
    var animator;
    
    var receiveUpdate = (function() {
        var queues = { };
        
        animator = function() {
            arguments.callee.isRunning = false;
            
            for(name in queues) {
                if(!queues[name] || queues[name].length == 0) { continue; }
                arguments.callee.isRunning = true;
                
                var nextPos = queues[name].shift();
                
                $("#" + name).animate({ left: nextPos.x, top: nextPos.y }, nextPos.delay, "swing", animator);
            }
        };
        animator.cancel = function cancel(name) {
            if(!name) { return; }
            
            queues[name] = [];
            $("#" + name).stop();
            animator();
        };
        
        return function receiveUpdate(shapeUpdates) {
            if(!shapeUpdates) { return; }
            
            for(name in shapeUpdates) {
                var points = shapeUpdates[name];
                if(!queues[name]) { queues[name] = []; }
                
                queues[name].push({ 'x': points[0].x, 'y': points[0].y, 'time': 50 });
                for(var i = 1; i < points.length; i++) {
                    queues[name].push({ 'x': points[i].x, 'y': points[i].y, 'delay': points[i].time - points[i - 1].time });
                }
            }
            if(!animator.isRunning) { animator(); }
        };
    })();
    
    var receivePlacements = function receivePlacements(shapes) {
        for(shape in shapes) {
            if($("#" + shape).length == 0) { 
                $("<div id='" + shape + "'/>")
                    .text(shapes[shape].word)
                    .appendTo("#shape-container")
                    .draggable({ containment: "#shape-container",
                                 start: function(e) { animator.cancel(this.id); },
                                 drag: function(e, ui) { sendUpdate(this.id, ui.position.left, ui.position.top); },
                                 stop: function(e, ui) { sendUpdate(this.id, ui.position.left, ui.position.top, true); } });
            }
            
            $("#" + shape).css({ left: shapes[shape].x, top: shapes[shape].y });
        }
    };
    
    $(document).ready(getPlacements);
//]]>
</script>
</lift:surround>