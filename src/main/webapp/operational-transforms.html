<lift:surround with="default" at="content">
    <lift:OperationalTransformsUI />
    <lift:comet type="OperationsDisplay" />
<script type="text/javascript">
//<![CDATA[
var transId = $("#edit").attr("transId");

(function() {
    var oldText = $("#edit").val();

    var diffText = (function() {
        function trimText(oldText, newText) {
            var startOffset = 0;
            for(var i = 0; i < oldText.length; i++) {
                if(oldText.charAt(i) !== newText.charAt(i)) { break; }
                startOffset++;
            }
            
            var oldTrim = oldText.substr(startOffset, oldText.length),
                newTrim = newText.substr(startOffset, newText.length);
            
            var endOffset = 0, oldLen = oldTrim.length - 1, newLen = newTrim.length - 1;
            for(i = 0; i < Math.min(oldTrim.length, newTrim.length); i++) {
                if(oldTrim.charAt(oldLen - i) !== newTrim.charAt(newLen - i)) { break; }
                endOffset++;
            }

            return { startOffset: startOffset, endOffset: endOffset,
                     oldTrim: oldTrim.substr(0, oldTrim.length - endOffset),
                     newTrim: newTrim.substr(0, newTrim.length - endOffset) };
        }
        
        return function diffText(oldText, newText) {
            var trim = trimText(oldText, newText), diff = [];
            
            if(trim.oldTrim === "") { diff.push({ cmd: "ins", pos: trim.startOffset, val: trim.newTrim }); }
            else if(trim.newTrim === "") { diff.push({ cmd: "del", pos: trim.startOffset, val: trim.oldTrim.length }); }
            else { // TODO: Implement hardcore diff algorithm...
                diff.push({ cmd: "del", pos: trim.startOffset, val: trim.oldTrim.length });
                diff.push({ cmd: "ins", pos: trim.startOffset, val: trim.newTrim });
            }
            
            return diff;
        };
    })();
    
    function expandDiff(diff) {
        var ops = [], pos = diff.pos, val = diff.val;
        
        if(diff.cmd == "ins") {
            for(var i = 0; i < val.length; i++) {
                ops.push({ cmd: "ins", pos: pos + i, val: val.charAt(i) });
            }
        } else if(diff.cmd == "del") {
            val = Number(val);
            for(var i = 0; i < val; i++) {
                ops.push({ cmd: "del", pos: pos + i });
            }
        }
        
        return ops;
    }
    
    function cmdSorter(a, b) {
        if(a.pos === b.pos) {
            if(b.cmd == a.cmd) { return 0; }
            
            if(b.cmd == "del") { return 1; }
            
            return -1;
        }

        return parseInt(b.pos, 10) - parseInt(a.pos, 10);
    }
        
    $("#edit").keyup(function() {
        var curText = $(this).val();
        
        if(oldText == curText) { return; }
        
        var diffs = diffText(oldText, curText),
            ops = [];
        
        
        for(var i = 0; i < diffs.length; i++) {
            ops = ops.concat(expandDiff(diffs[i]));
        }
        
        ops.sort(cmdSorter);
        window.ops = ops;
        sendOperations(transId++, JSON.stringify(ops));
        oldText = curText;
    });
})();
//]]>  
</script>
</lift:surround>