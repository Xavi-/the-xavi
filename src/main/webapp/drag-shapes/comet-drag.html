<lift:surround with="default" at="content">
<head>
    <style>
    /*<![CDATA[*/    
    #shape-container
    {
        position: relative;
        width: 500px;
        height: 500px;
        border: 1px solid black;
    }
    
    #shape-container div
    {
        position: absolute;
        width: 100px;
        height: 100px;
        background: green;
        cursor: move;
    }
    /*]]>*/
    </style>
    <script type="text/javascript" src="/classpath/json.js" id="json"/>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.1/jquery-ui.min.js"/>
</head>
<div id="shape-container">
    <lift:comet type="CometDragDisplay"/>
</div>
<script type="text/javascript">
//<![CDATA[
    var sendUpdate = (function() {
        var lastSent = (new Date()).getTime();
        var queue = [];
        
        return function sendUpdate(name, x, y, forced) {
            var curTime = (new Date()).getTime();
            
            if(!forced && curTime - lastSent < 50) { return; }
            
            if(!forced && queue.length > 0 && curTime - queue[queue.length - 1][2] < 50) { return; }
            
            queue.push([ x, y, curTime ]);
            
            if(!forced && queue.length > 0 
                && curTime - queue[queue.length - 1][2] < 150 && curTime - lastSent < 1000) { return; }
            
            if(!forced && curTime - lastSent < 300) { return; }
            
            lastSent = curTime;
            var message = {}; message[name] = queue;
            moveShape(message);
            queue = [];
        };
    })();
    
    var receiveUpdate = (function() {
        var queues = { };
        
        function animator() {
            arguments.callee.isRunning = false;
            
            if(!queues) { return; }
            
            for(name in queues) {
                if(!queues[name] || queues[name].length == 0) { continue; }
                arguments.callee.isRunning = true;
                
                var nextPos = queues[name].shift();
                
                $("#" + name).animate({ left: nextPos.x, top: nextPos.y }, nextPos.delay, "swing", animator);
            }
        }
        
        return function receiveUpdate(shapeUpdates) {
            if(!shapeUpdates) { return; }
            
            for(name in shapeUpdates) {
                var points = shapeUpdates[name];
                if(!queues[name]) { queues[name] = []; }
                
                queues[name].push({ 'x': points[0].x, 'y': points[0].y, 'time': 50 });
                for(var i = 1; i < points.length; i++) {
                    queues[name].push({ 'x': points[i].x, 'y': points[i].y, 'delay': points[i].time - points[i - 1].time });
                }
            }
            if(!animator.isRunning) { animator(); }
        };
    })();
    
    $(document).ready(function addDrag() {
        $("##shape-container div")
            .draggable({ containment: "#shape-container",
                         drag: function(e, ui) { sendUpdate(this.id, ui.position.left, ui.position.top); },
                         stop: function(e, ui) { sendUpdate(this.id, ui.position.left, ui.position.top, true); } });
    });
//]]>
</script>
</lift:surround>